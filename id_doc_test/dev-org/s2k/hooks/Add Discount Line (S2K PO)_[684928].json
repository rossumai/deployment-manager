{
  "id": 684928,
  "type": "function",
  "name": "Add Discount Line (S2K PO)",
  "url": "https://us.api.rossum.ai/v1/hooks/684928",
  "description": "",
  "settings": {},
  "active": false,
  "events": [
    "annotation_content.export"
  ],
  "queues": [
    "https://us.api.rossum.ai/v1/queues/1771791"
  ],
  "run_after": [],
  "metadata": {},
  "config": {
    "schedule": {
      "cron": ""
    },
    "app": null,
    "payload_logging_enabled": false,
    "timeout_s": 30,
    "max_polling_time_s": 300,
    "retry_count": 4,
    "retry_after_polling_failure": true,
    "runtime": "python3.12",
    "code": "from txscript import TxScript, default_to, substitute, is_set\nfrom copy import deepcopy\nimport dataclasses\n\nDISCOUNT_VIRTUAL_LINE_TYPE = \"discount\"\n\ndef rossum_hook_request_handler(payload: dict) -> dict:\n    t = TxScript.from_payload(payload)\n\n    total_discount = 0\n    existing_row_index = None\n    for row in t.field.line_items:\n        # Line has a discount column\n        if is_set(row.item_amount_discount):\n            total_discount += abs(row.item_amount_discount)\n        # The discount line was already added previously -> update\n        if is_set(row.flag_virtual_discount_line) and row.flag_virtual_discount_line == DISCOUNT_VIRTUAL_LINE_TYPE:\n            existing_row_index = row._index\n            \n    if existing_row_index is not None:\n        t.field.line_items.pop(existing_row_index)\n            \n    if total_discount == 0:\n        return t.hook_response()\n    \n    discount_row = {}\n    # Assumption: all lines should be from the same PO = same location = same branch\n    branches = t.field.item_branch_id_normalized.all_values\n    discount_row[\"item_branch_id_extension\"] = branches[0] if len(branches) else \"\"\n    discount_row[\"item_gl_code_extension\"] = '510000'\n    discount_row[\"item_dept_extension\"] = '00'\n    discount_row[\"item_amount_total\"]= -total_discount\n    discount_row[\"flag_virtual_discount_line\"]= DISCOUNT_VIRTUAL_LINE_TYPE\n    \n    t.field.line_items.append(discount_row)\n    response = t.hook_response()\n    \n     # Does not work because of formula fields being populated\n    schema_ids_to_keep = list(discount_row.keys())\n    add_operation_index = 0 if existing_row_index is None else 1\n    response['operations'][add_operation_index]['value'] = [op for op in response['operations'][add_operation_index]['value'] if op['schema_id'] in schema_ids_to_keep]\n    \n    return response",
    "third_party_library_pack": "default",
    "memory_size_mb": 256
  },
  "test": {},
  "sideload": [
    "schemas"
  ],
  "settings_schema": null,
  "secrets_schema": {
    "type": "object",
    "additionalProperties": {
      "type": "string"
    }
  },
  "token_owner": "https://us.api.rossum.ai/v1/users/383208",
  "extension_source": "custom",
  "guide": null,
  "read_more_url": null,
  "extension_image_url": null,
  "token_lifetime_s": null,
  "hook_template": null,
  "created_by": null,
  "created_at": null,
  "modified_by": "https://us.api.rossum.ai/v1/users/354857",
  "modified_at": "2025-03-25T16:15:18.046286Z"
}