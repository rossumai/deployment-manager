{
  "id": 718139,
  "type": "function",
  "name": "Add Inventory Variances (S2K PO)",
  "url": "https://us.api.rossum.ai/v1/hooks/718139",
  "description": "Calculates unit price and quantity variances for each line item and sums them up into a header field.",
  "settings": {},
  "active": true,
  "events": [
    "annotation_content.export"
  ],
  "queues": [
    "https://us.api.rossum.ai/v1/queues/1771791"
  ],
  "run_after": [],
  "metadata": {},
  "config": {
    "schedule": {
      "cron": ""
    },
    "app": null,
    "payload_logging_enabled": false,
    "timeout_s": 30,
    "max_polling_time_s": 300,
    "retry_count": 4,
    "retry_after_polling_failure": true,
    "runtime": "python3.12",
    "code": "from txscript import TxScript, default_to, substitute, is_set, is_empty\nfrom copy import deepcopy\nimport dataclasses\n\ndef rossum_hook_request_handler(payload: dict) -> dict:\n    t = TxScript.from_payload(payload)\n\n    total_price_variance = 0\n    total_quantity_variance = 0\n    for row in t.field.line_items:\n        max_allowed_quantity = float(default_to(row.item_quantity_open, '.00'))\n        captured = default_to(row.item_quantity_export, 0)\n        \n        po_unit_price = float(default_to(row.item_amount_base_match.value, '0').replace(',', '.'))\n        invoice_unit_price = float(default_to(row.item_amount_export, '0'))\n        \n        \n        if is_set(row.item_order_invoice_quantity_ratio_match) and row.item_use_ratio == 'true':\n            ratio = float(row.item_order_invoice_quantity_ratio_match)\n            if ratio != 0:\n                captured = captured * ratio    \n        \n        \n        extra_quantity = captured - max_allowed_quantity\n        if extra_quantity > 0:\n            total_quantity_variance += extra_quantity * po_unit_price\n\n    \n        extra_price = invoice_unit_price - po_unit_price\n        total_price_variance += captured * extra_price\n            \n    t.field.inventory_price_variances = round(total_price_variance, 2)\n    t.field.inventory_quantity_variances = round(total_quantity_variance, 2)\n        \n    return t.hook_response()",
    "third_party_library_pack": "default",
    "memory_size_mb": 256
  },
  "test": {},
  "sideload": [
    "schemas"
  ],
  "settings_schema": null,
  "secrets_schema": {
    "type": "object",
    "additionalProperties": {
      "type": "string"
    }
  },
  "token_owner": "https://us.api.rossum.ai/v1/users/383208",
  "extension_source": "custom",
  "guide": null,
  "read_more_url": null,
  "extension_image_url": null,
  "token_lifetime_s": null,
  "hook_template": null,
  "created_by": "https://us.api.rossum.ai/v1/users/354857",
  "created_at": "2025-03-26T07:44:17.888778Z",
  "modified_by": "https://us.api.rossum.ai/v1/users/354857",
  "modified_at": "2025-05-05T08:01:34.347977Z"
}